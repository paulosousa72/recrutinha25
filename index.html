<!DOCTYPE html>
<html>
<head>
    <title>AR com X3DOM</title>
    <style>
        body { margin: 0; overflow: hidden; }
        x3d { width: 100vw; height: 100vh; border: none; }
        #startARButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        #startARButton:hover {
            background-color: #45a049;
        }
        #versionLabel {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
    </style>
    <script src="https://x3dom.org/download/x3dom.js"></script>
</head>
<body>
    <x3d id="x3dScene">
        <scene id="scene">
            <Viewpoint id="viewpoint" position="0 1.6 -5" orientation="0 0 1 0"></Viewpoint>
            <PointLight id="light" location="0 3 0" intensity="1.0"></PointLight>
            <Transform id="modelTransform" scale="0.5 0.5 0.5" rotation="0 1 0 3.14159">
                <Inline id="model" url="./anime.glb"></Inline>
            </Transform>
        </scene>
    </x3d>
    <button id="startARButton">Iniciar AR</button>
    <div id="versionLabel">Versão 1.0</div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("X3DOM carregado, iniciando configuração...");

            const x3dElement = document.getElementById("x3dScene");
            const scene = document.getElementById("scene");
            const modelTransform = document.getElementById("modelTransform");
            const startARButton = document.getElementById("startARButton");

            // Verifica se o modelo foi carregado
            const model = document.getElementById("model");
            model.addEventListener("load", () => {
                console.log("Modelo anime.glb carregado com sucesso!");
            });
            model.addEventListener("error", (err) => {
                console.error("Erro ao carregar o modelo:", err);
                alert("Erro ao carregar o modelo: " + err.detail);
            });

            // Configura WebXR para AR
            startARButton.addEventListener("click", async () => {
                console.log("Botão clicado, tentando entrar no modo AR...");
                if (!navigator.xr) {
                    alert("WebXR não é suportado neste navegador.");
                    console.log("WebXR não suportado.");
                    return;
                }

                try {
                    const session = await navigator.xr.requestSession("immersive-ar", {
                        requiredFeatures: ["local-floor", "hit-test"],
                        optionalFeatures: ["dom-overlay"]
                    });

                    // Configura o espaço de referência
                    const referenceSpace = await session.requestReferenceSpace("local-floor");
                    const viewerSpace = await session.requestReferenceSpace("viewer");
                    const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

                    // Configura o glTF/X3DOM para renderizar no WebXR
                    const gl = x3dElement.getContext("webgl");
                    const xrGlBinding = new XRWebGLBinding(session, gl);

                    const onXRFrame = (time, frame) => {
                        const session = frame.session;
                        const glLayer = session.renderState.baseLayer;
                        gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);

                        const hitTestResults = frame.getHitTestResults(hitTestSource);
                        if (hitTestResults.length > 0) {
                            const hit = hitTestResults[0];
                            const hitPose = hit.getPose(referenceSpace);
                            if (hitPose) {
                                const position = hitPose.transform.position;
                                modelTransform.setAttribute("translation", `${position.x} ${position.y} ${position.z}`);
                                console.log("Modelo posicionado em:", position.x, position.y, position.z);
                            }
                        }

                        session.requestAnimationFrame(onXRFrame);
                    };

                    session.addEventListener("end", () => {
                        startARButton.style.display = "block"; // Mostra o botão novamente se o AR terminar
                    });

                    session.requestAnimationFrame(onXRFrame);
                } catch (err) {
                    console.error("Erro ao entrar no AR:", err.message);
                    alert("Erro ao entrar no AR: " + err.message);
                }
            });
        });
    </script>
</body>
</html>
